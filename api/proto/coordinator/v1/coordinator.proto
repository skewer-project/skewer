syntax = "proto3";

package api.proto.coordinator.v1;

option go_package = "github.com/skewer-project/skewer/api/proto/coordinator/v1;coordinatorv1";

/*
   Server: Coordinator
   Clients: User + Renderer workers + Compositor worker
*/

/*
   Container service:
   Manages the DAG (Directed Acyclic Graph) of Render/Composite Jobs
   and distributes granular Tasks to GKE workers.
*/

service CoordinatorService {
  // External API for CLI
  rpc SubmitJob(SubmitJobRequest) returns (SubmitJobResponse);
  rpc GetJobStatus(GetJobStatusRequest) returns (GetJobStatusResponse);
  rpc CancelJob(CancelJobRequest) returns (CancelJobResponse);

  // Internal API for Skewer and Loom GKE Workers
  rpc GetWorkStream(GetWorkStreamRequest) returns (stream WorkPackage);
  rpc ReportTaskResult(ReportTaskResultRequest) returns (ReportTaskResultResponse);
}

///* "Job" Submission Level *///
message SubmitJobRequest {
  string job_id = 1; // UUID of job for tracking
  string job_name = 2; // eg. "smoke_layer", "ball_layer", "final_composite"

  repeated string depends_on = 3;

  // General job information
  int32 num_frames = 4;
  int32 width = 5;
  int32 height = 6;

  oneof job_type {
    RenderJob render_job = 7;
    CompositeJob composite_job = 8;
  }
}

message RenderJob {
  string scene_uri = 1;
  int32 total_samples = 2; // number of rays shot per pixel e.g., 1024
  int32 sample_division = 3; // e.g., 4 (spawns 4 tasks of 256 samples per frame)
  string output_uri_prefix = 4; // gs://bucket/renders/smoke/
}

message CompositeJob {
  // The layers to combine. For frame x, Loom will look for:
  // gs://bucket/renders/smoke/frame-0005.exr and gs://bucket/renders/person/frame-0005.exr
  repeated string layer_uri_prefixes = 1;
  string output_uri_prefix = 2;
}

message SubmitJobResponse {
  string job_id = 1;
}

///* Job Tracking API for User *///
message GetJobStatusRequest {
  string job_id = 1;
}

message GetJobStatusResponse {
  enum JobStatus {
    JOB_STATUS_UNSPECIFIED = 0;
    JOB_STATUS_PENDING_DEPENDENCIES = 1; // waiting for dependency jobs
    JOB_STATUS_QUEUED = 2;
    JOB_STATUS_RUNNING = 3;
    JOB_STATUS_COMPLETED = 4;
    JOB_STATUS_FAILED = 5;
  }
  JobStatus job_status = 1;
  float progress_percent = 2;
  string error_message = 3;
}

message CancelJobRequest {
  string job_id = 1;
}

message CancelJobResponse {
  bool success = 1;
}

///* Worker Execution *///
message GetWorkStreamRequest {
  string worker_id = 1; // UUID of skewer/loom pod

  // Any tags to ensure workers only get tasks they can handle
  // e.g., ["gpu", "skewer"] or ["high-mem", "loom"]
  repeated string capabilities = 2;
}

message WorkPackage {
  string job_id = 1;
  string task_id = 2;
  string frame_id = 3;

  oneof payload {
    // Run by Skewer: Render a sample chunk
    RenderTask render_task = 4;

    // Run by Loom: Ingests partial Deep EXRs, depth-sorts the linked lists, and merges samples at the same Z-depth
    MergeTask merge_task = 5;

    // Run by Loom: Ingests final Deep EXRs from entirely different Jobs (e.g. Smoke + Person) and deep-merges them
    CompositeTask composite_task = 6;
  }
}

message RenderTask {
  // Scene information
  string scene_uri = 1;
  int32 width = 2;
  int32 height = 3;

  // Sample division range
  int32 sample_start = 4;
  int32 sample_end = 5;

  string output_uri = 6; // gs://bucket/renders/smoke/frame-0005-chunk-0.exr
}

message MergeTask {
  // The PARTIAL deep EXR chunks in a given frame to sort and merge (e.g., render chunk 0 to 3)
  repeated string partial_deep_exr_uris = 1;
  string output_uri = 2;
}

message CompositeTask {
  // The merged, FINAL Deep EXR frames from different Render Jobs to holdout/blend (after they've been "merged" from sample splitting)
  repeated string layer_uris = 1;

  int32 width = 2;
  int32 height = 3;

  string output_uri = 4; // flattened 2D image
}

///* Worker Reporting *///
message ReportTaskResultRequest {
  // Identification of the job task and worker (may need to add frame number)
  string task_id = 1;
  string job_id = 2;
  string worker_id = 3;

  // Generic response information
  bool success = 4;
  string error_message = 5;
  string output_uri = 6;

  int64 execution_time_ms = 7; // for metrics
}

message ReportTaskResultResponse {
  bool acknowledged = 1;
}
