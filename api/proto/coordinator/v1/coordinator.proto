syntax = "proto3";

package api.proto.coordinator.v1;

option go_package = "./api/proto/coordinator/v1";

/*
   Server: Coordinator
   Clients: User + Renderer workers + Compositor worker
*/

service CoordinatorService {
  // === CLI API (External) ===

  // Submit a new render job
  rpc SubmitJob(SubmitJobRequest) returns (SubmitJobResponse);

  // Get job status
  rpc GetJobStatus(GetJobStatusRequest) returns (GetJobStatusResponse);

  // Cancel a running job
  rpc CancelJob(CancelJobRequest) returns (CancelJobResponse);

  // === Worker API (Internal - Streaming Pull) ===

  // Worker connects once, holds this stream open indefinitely
  // Coordinator BLOCKS on this call until work is available
  rpc GetWorkStream(GetWorkStreamRequest) returns (stream WorkPackage);

  // Worker reports result of completed task
  rpc ReportTaskResult(ReportTaskResultRequest) returns (ReportTaskResultResponse);
}

/* CLI Messages */

message SubmitJobRequest {
  string scene_uri = 1; // GCS path to scene file
  int32 frame_start = 2;
  int32 frame_end = 3;
  int32 samples_per_pixel = 4;
  int32 width = 5;
  int32 height = 6;
  string output_uri = 7; // Where to save final result
}

message SubmitJobResponse {
  string job_id = 1;
}

message GetJobStatusRequest {
  string job_id = 1;
}

message GetJobStatusResponse {
  enum JobStatus {
    JOB_STATUS_PENDING_UNSPECIFIED = 0;
    JOB_STATUS_QUEUED = 1;
    JOB_STATUS_RENDERING = 2;
    JOB_STATUS_COMPOSITING = 3;
    JOB_STATUS_COMPLETED = 4;
    JOB_STATUS_FAILED = 5;
  }
  JobStatus status = 1;
  float progress_percent = 2;
  string output_uri = 3; // Final result if completed
}

message CancelJobRequest {
  string job_id = 1;
}

message CancelJobResponse {
  bool success = 1;
}

/* Worker Messages */

message GetWorkStreamRequest {
  string worker_id = 1;
  string worker_capabilities = 2; // e.g., "cpu", "gpu", "high-mem"
}

message WorkPackage {
  string job_id = 1; // which animation job
  string task_id = 2; // unique ID for this task
  int32 frame_id = 3; //which frame

  // Frame size
  int32 width = 7;
  int32 height = 8;

  // Only can be ONE type of task
  oneof payload {
    RenderTask render_task = 4;
    CompositeTask composite_task = 5;
  }
}

message RenderTask {
  // Render frame information
  string scene_uri = 1;

  // Which set of samples to render
  int32 sample_start = 2;
  int32 sample_end = 3;
  int32 total_samples = 4;

  // Where to upload EXR
  string output_uri = 9;
}

message CompositeTask {
  repeated string frame_uris = 3; // All frame EXRs to merge
  string output_uri = 4; // Final output
}

message ReportTaskResultRequest {
  // Information to identify the task, worker, job and frame
  string job_id = 1;
  string task_id = 2;
  string worker_id = 3;
  int32 frame_id = 4;

  // Basic status report information
  bool success = 5;
  string output_uri = 6; // Result file URI
  string error_message = 7;

  // Metric data
  int64 execution_time_ms = 8;
}

message ReportTaskResultResponse {
  bool acknowledged = 9;
}
